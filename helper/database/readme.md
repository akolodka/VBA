# Менеджер работ с базами данных
Библиотека реализует первые два из четырёх шагов концепции оформления результатов типовой метрологической работы: поиск в собственной базе и загрузка из неё шаблона Excel для обработки данных по конкретному средству измерений (шаг 1), передача сведений контрагента в загруженный шаблон обработки данных Excel (шаг 2).

## Изобретение велосипеда
Первоначально возникла потребность хранить 3 группы текстовых данных:
- сведения контрагентов:
  - идентификатор контрагента (ключевое слово)
  - наименование краткое;
  - ИНН;
  - юридический адрес;
- средства измерений:
  - наименование полное;
  - тип (аббревиатура);
  - регистрационный номер (является идентификатором);
  - шифр и наименование документа на выполнение работ;
- эталоны и вспомогательное оборудование:
  - наименование полное;
  - регистрационный номер;
  - идентификатор;
  - сведения о сроке действия.

Впоследствии потребовалось дополнитель группы данными: 
- средства измерений:
  - набор файлов (количество произвольно), привязанный к конкретному элементу таблицы;
  - перекрёстная ссылка (указатель) на элемент таблицы, из которого следует загружать шаблоны файлов;
  - возможность поверки в ранге эталона (флаг);
- сведения исполнителей работ:
  - фамилия, имя и отчество полные;
  - дожность в подразделении;
  - право выполнять поверочные работы (флаг);
- архив выполненных работ.

Самый простой способ организации данных — таблица. Самый простой способ организации таблиц — Excel.
Каждый раз открывать книгу Excel для считывания данных ресурсозатратно (и долго), потому таблицы были перенесены в текстовые файлы.

При разработке библиотеки очень быстро пришло понимание, что ненужно создавать несколько однотипных механизмов обращения к обособленным таблицам данных, необходимо иметь единый механизм, который будет предоставлять сведения в ответ на запрос, адресованный конкретной таблице. 

## Две архитектуры библиотеки
Старая архитектура — плохая презентация: собрание WET-кода, бизнес-логика размещена в UserForm и завязана на её вызове, попытки применять systems hungarian, повсеместные public методы, а также переменные, которые многократно применяются внутри мега-класса. Это не то, что стоит показывать. Это причина построения новой архитектуры. 

Вместе с тем, золотое правило разработки — не трогать то, что работает.

Компоненты библиотеки старой архитектуры имеют префикс имени «z_...» для отображения внизу списка.

## Возможности библиотеки (старая архитектура) на примере базы данных средств измерений
Изначальная концепция следующая. Имеется книга Excel, в которой создана форма документа для обработки данных. В этой форме присутствуют поля (ячейки), в которые независимо от типа средства измерений помещаются идентификационные данные из таблицы базы данных:

![Title](https://github.com/akolodka/VBA/blob/main/resources/protocol_fields.jpg)

Исходные задачи две:
- найти, что передавать;
- найти, куда передавать.

Пользовательская форма, вызываемая по клику на кнопку Ribbon-меню:

![Title](https://github.com/akolodka/VBA/blob/main/resources/databaseOld_Main.jpg)

При вызове формы в память загружаются:
- конфигурация пользователя для получения пути к таблице данных;
- таблица из файла данных в виде массива;
- таблица соответствия символов английской и русской раскладки клавиатуры (q = й, w = ц и т.д.) из соответствующего файла;
- последний поисковый запрос из файла кэша;
- последняя выбранная позиция в списке результатов поиска (ListBox) из файла кэша.

Алгоритм поиска данных:
- получить поисковую строку из поля ввода;
- конвертировать строку с учётом альтернативного языка ввода: 
  - «йцукен» => «йцукен qwerty»;
  - «qwerty» => «qwerty йцукен»;
- разбить конвертированную строку на части, получить массив ключей поиска;
- построчно пройтись по каждому элементу таблицы данных:
  - выполнить поиск в рассматриваемой строке каждого элемента массива ключей;
  - если в результате совпало не менее половины от общего количества ключей, добавить элемент в результаты поиска.

Пример: необходимо найти в базе сведения о спектрометре гамма-излучения Canberra. 

Результат поиска при вводе запроса в виде одной группы символов (67 результатов):

![Title](https://github.com/akolodka/VBA/blob/main/resources/databaseOld_searchOne.jpg)

Результат поиска при вводе запроса в виде двух групп символов (38 результатов):

![Title](https://github.com/akolodka/VBA/blob/main/resources/databaseOld_searchTwo.jpg)

Результат поиска при вводе запроса в виде трёх групп символов (3 результата):

![Title](https://github.com/akolodka/VBA/blob/main/resources/databaseOld_searchThree.jpg)

Результат поиска при вводе запроса в виде четырёх групп символов (единственный результат):

![Title](https://github.com/akolodka/VBA/blob/main/resources/databaseOld_searchFour.jpg)

---
Для внесения изменений в таблицу данных необходимо нажать на строку «внести изменения в базу данных...», которая располагается в конце списка результатов поиска.
В результате произойдёт загрузка формы конструктора базы данных, где будет выбран элемент, ранее отмеченный в поисковой форме:

![Title](https://github.com/akolodka/VBA/blob/main/resources/databaseOld_Constructor2.jpg)

Возможные команды в конструкторе данных:
- быстрый переход к элементу по вводимому запросу, нажатие Enter переводит к следующему результату поиска;
- подготовить стандартные шаблоны документов для выделенного элемента;
- открыть каталог с файлами для выбранного элемента;
- добавить новый элемент;
- обновить данные выделенного элемента;
- удалить выделенный элемент;
- вставить перекрёстную ссылку для выделенного элемента на другой элемент таблицы данных;
- установить флаг «эталон» для возможности поверки в ранге эталона;
- сохранить изменения.

Результат быстрого перехода с последующим изменением параметра:

![Title](https://github.com/akolodka/VBA/blob/main/resources/databaseOld_ConstructorUpdate.jpg)

При выполнении быстрого перехода к элементу применяется поиск независимо от языка ввода аналогично основной поисковой форме.

Идея вставки текстовых данных в поля активной книги Excel впоследствии была дополнена предварительной загрузкой файла-шаблона Excel из индивидуального каталога данных средства измерений.

## Конструктор файла-шаблона обработки данных
Шаблон обработки данных представляет собой книгу Excel, где на листе присутствуют пустые ячейки к заполнению, а также поясняющие записи для удобочитаемости.

Операции загрузки файла-шаблона обработки данных следующие:
- получить идентификатор элемента базы данных, для которого загружается шаблон;
- скопировать файл из каталога распололжения шаблона в рабочий каталог;
- найти по ключам и заполнить ячейки данными средства измерений (наименование, тип и т.д.);
- заполнить сведения исполнителя работ (из таблицы данных ФИО).

Система менеджмента качества предприятия, где разрабатывалась библиотека, устанавливает требования к оформлению выпускаемой отчётной документации. После выпуска очередных изменений требований возникли неудобства ввиду потребности корректировать вручную n (n > 40 на тот момент) шаблонов документов. 

Возникла идея сборки файла обработки данных из двух частей:
- файл «шапка» с вёрсткой для заполнения формальными данными, который будет единым для всех загружаемых шаблонов;
- файл «тело» с версткой для заполнения данными конкретной модификации средства измерений.

Наполнение файла-шапки шаблона:

![Title](https://github.com/akolodka/VBA/blob/main/resources/pr_base.jpg)

Наполнение файла-тела шаблона:

![Title](https://github.com/akolodka/VBA/blob/main/resources/pr_body.jpg)

Для загрузки файла-шаблона выполняются операции:
- получить идентификатор элемента базы данных, для которого загружается шаблон;
- получить полный путь к файлу «тела» шаблона элемента базы данных;
- получить полный путь к файлу «шапки» шаблона;
- скопировать файл «шапки» из специального каталога в рабочий каталог;
- получить и скопировать диапазон строк «тела» файла обработки данных;
- вставить строки в скопированный ранее файл «шапки»;
- найти по ключам и заполнить ячейки данными средства измерений (наименование, тип и т.д.);
- заполнить сведения исполнителя работ (из таблицы данных ФИО).

Для одного типа средства измерений возможны несколько модификаций, которые отличаются набором операций поверки. Это привело к созданию множества файлов «body» в рамках одного каталога данных:

![Title](https://github.com/akolodka/VBA/blob/main/resources/pr_list.jpg)

Для выбора конкретного тела шаблона предусмотрена дополнительная форма, вызываемая при поиске в базе средств измерений. Форма также поддерживает фильтрацию результатов независимо от раскладки клавиатуры:

![Title](https://github.com/akolodka/VBA/blob/main/resources/body_select.jpg)

---

Разные средства измерений могут иметь схожие операции поверки и, соответственно, схожее наполнение файлов body.
Чтобы не дублировать однотипные документы в разных каталогах, была реализована концепция перекрёстной ссылки. Установка такого флага позволят выполнять копирование тела шаблона обработки данных из каталога другого элемента.

## Возможности библиотеки (новая архитектура) на примере базы данных контрагентов

Причины рефакторинга библиотеки:
- сложность сопровождения кода ввиду плохой архитектуры проекта;
- низкая отказоустойчивость системы: в центре бизнес-логики файл таблицы данных, при нарушении целостности которого невозможно получить доступ к файлам элементов таблицы в каталогах.

Результаты рефакторинга:
- написана с нуля подсистема работы с конфигурацией и кэшем данных;
- бизнес-логика отделена от UserForm;
- конструктор базы данных упразднён;
- инвертирована концепция бизнес-логики: файл таблицы данных теперь является кэшем данных из каталогов, в центре бизнес-логики конкретный элемент базы.

Концепция новой архитектуры следующая. Каждый элемент базы представляет собой каталог с именем-ключом, внутри каталога располагается файл с именем-ключом, хранящий сведения об элементе базы, а также любые дополнительные файлы:

![Title](https://github.com/akolodka/VBA/blob/main/resources/databaseFileContent.jpg)

Вся база данных представляет собой набор каталогов: 

![Title](https://github.com/akolodka/VBA/blob/main/resources/databaseOrganisations.jpg)

Для выполнения поиска по базе происходит кеширование части данных каждого элемента базы во временный файл, пример наполнения кэш-файла:

![Title](https://github.com/akolodka/VBA/blob/main/resources/databaseCacheContent.jpg)

Таким образом, нарушение целостности кэш-таблицы данных, а также конкретного элемента базы не сказывается на других элементах. В любой момент времени возможно перекэширование.

Содержимое кэш-файла загружается в память и представляется единой строкой. 
Поиск осуществляется на основании определения первого вхождения символов искомого запроса в строке кэш-файла (InStr).
Введена задержка обработки результата поискового запроса для исключения каскадного эффекта.

---

Алгоритм поиска данных новой архитектуры:
- загрузить в память кэш-файл данных;
  - кэшировать данные, если кэш-файл отсутствует;
- получить поисковую строку из поля ввода;
- конвертировать строку с учётом альтернативного языка ввода: 
  - «йцукен» => «йцукен qwerty»;
  - «qwerty» => «qwerty йцукен»;
- разбить конвертированную строку на части, получить массив ключей поиска;
- выполнить поиск первого вхождения в строку кэш-файла данных первого ключа массива ключей;
- выделить полную строку элемента из кеш-файла данных;
- проверить присутствие остальных ключей в выделенной строке элемента;
  - если в результате совпало не менее половины от общего количества ключей, добавить элемент в результаты поиска.
- продолжить поиск первого вхождения первого ключа в строку кэш-файла данных с позиции окончания ранее выделенной строки.
  
---
Пользовательская форма для работы с базой данных:

![Title](https://github.com/akolodka/VBA/blob/main/resources/databaseNew_MainForm.jpg)

Для добавления нового элемента необходимо ввести уникальный ключ. Пример уведомления пользователя в результате ввода недоступного и свободного ключа:

![Title](https://github.com/akolodka/VBA/blob/main/resources/databaseNew_AddExistingItem.jpg) ![Title](https://github.com/akolodka/VBA/blob/main/resources/databaseNew_AddNewItem.jpg)

После нажатия на кнопку «Принять» будет открыт файл элемента базы данных, заполненный по умолчанию:

![Title](https://github.com/akolodka/VBA/blob/main/resources/databaseNew_NewItemData.jpg) 

Корректировка данных выполняется напрямую через текстовый редактор. При следующем запуске пользовательской формы будет произведено кэширование данных во временный файл:

![Title](https://github.com/akolodka/VBA/blob/main/resources/databseNew_CachigData.jpg) 

После загрузки пользовательской формы новый элемент базы данных будет первым в списке предложений:

![Title](https://github.com/akolodka/VBA/blob/main/resources/databaseNew_SuggestionItem.jpg)  

База данных контрагентов применяется, в первую очередь, для передачи сведений контагентов в файл-шаблон обработки данных:
- в подготовленные ячейки;
- в свойство книги Excel.

Обращение с формой базы данных возомжно как с применением указателя мыши, так и без него.
По умолчанию передача данных контрагента выполняется по нажатию на Enter. 


## Установка и настройка библиотеки
Для установки библиотеки поместить файл helper_database.xlam в каталог автозагрузки Excel:
``` 
%appdata%\Microsoft\Excel\XLSTART\
```
После установки на Ribbon-ленте Excel повляется выпадающее меню для доступа к настройкам:

![Title](https://github.com/akolodka/VBA/blob/main/resources/database_RibbonMenu.jpg)

При первом запуске с Ribbon ленты, а также в случае отсутствия файла конфигурации будет запущена форма настроек пользователя.
Пользовательская форма для работы с конфигурацией:

![Title](https://github.com/akolodka/VBA/blob/main/resources/database_ConfigMenu.jpg) 

Для подключения имеющейся базы данных необходимо выбрать начальный каталог.

Ввиду совщемения старой и новой архитектуры форма настроек содержит ссылку на старую форму настроек (слева от кнопки Somnium):

![Title](https://github.com/akolodka/VBA/blob/main/resources/database_ConfigOld2.jpg)


## Доступ к исходному коду из VBA IDE 
Проект библиотеки защищён паролем «1» ввиду обилия компонентов, по умолчанию отображающихся списком в IDE.

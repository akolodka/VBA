# Менеджер обновлений библиотек «Помощник ПКР»
При наличии более чем одного пользователя ПО возникает вопрос распространения обновлений. 

Установка библиотек *.xlam не требует регистрации в реестре системы и сводится к замене исполняемого файла в соответствующем каталоге автозапуска MS Office. Но есть нюансы:
- нельзя заменить файл, который в настоящее время используется, а при старте Excel библиотеки запускаются в фоне;
- можно программно закрыть файл библиотеки (надстройки), скопировать обновление и снова подключить файл, но тогда нарушается последовательность отображения меню Ribbon-ленты до следующего перезапуска Excel (библиотеки запускаются последовательно по алфавиту).

## Область применения
Режимы работы updater:
- проверка обновлений с уведомлением пользователя, установка не производится;
- автоустановка обновлений в фоновом режиме без уведомления пользователя.

Библиотека распространяется на файлы:
- Excel (*.xlam) — помещаются в каталог:
``` 
%appdata%\Microsoft\Excel\XLSTART\
```
- Word (*.dotm) — помещаются в каталог:
``` 
%appdata%\Microsoft\Word\STARTUP\
```
- Другие файлы, если таковые обнаружены в служебном локальном каталоге «Помощник ПКР» на компьютере пользователя — помещаются в каталог:
``` 
%appdata%\Помощник ПКР\
```

## Принцип работы
Проект имеет две функциональные части:
- проверка доступности обновлений;
- установка обновлений.

### Проверка наличия обновлений
Проверка доступности обновлений включается в себя операции:
1. получение списка файлов, доступных для обновления;
2. определение статуса доступности обновлений;
3. фиксация даты проверки обновлений;
4. запись результатов проверки в кеш-файл, расположенный по адресу:
``` 
%appdata%\Помощник ПКР\cache\updater.txt
```
Список файлов, доступных для обновления, получается на основании обращения к каталогу обновлений из настроек пользователя.

Статус доступности обновления определяется на основании:
- наличия установленного локально файла библиотеки (поиск по имени);
- сравнения даты изменения установленного локально файла библиотеки и файла обновления.

При установке в настройках флага автопроверки обновлений, проверка доступности обновлений будет производиться раз в сутки и привязана к событию Workbook_Open().

### Установка обновлений

# ПРАВИТЬ ОТСЮДА

Установка обновлений в автоматическом режиме выполняется через событие Workbook_BeforeClose(). 
Если флаг isUpdateAvailable имеет значение False, происходит завершение процедуры и прерывание операций установки. 

Операции установки:
- выполнение п.1 — п.5 проверки доступности обновлений для каждого файла в каталоге обновлений;
- выполнение отключения запущенных библиотек в зависимости от типа файла:
  - для файлов *.xlam выполняется принудительное закрытие;
  - для файлов *.dotm выполняется проверка запущенного процесса WINWORD.EXE, и, если процесс обнаружен, отключение данного файла от Office;
- копирование нового файла в соответствующий каталог.

## Уведомление пользователя о наличии обновления
Уведомление появляется на Ribbon-ленте Excel только при работе в ручном режиме:

![Title](https://github.com/akolodka/VBA/blob/main/resources/update_available.jpg) ![Title](https://github.com/akolodka/VBA/blob/main/resources/update_unAvailable.jpg)

## Установка и настройка библиотеки
Для установки библиотеки поместить файл helper_updater.xlam в каталог автозагрузки Excel:
``` 
%appdata%\Microsoft\Excel\XLSTART\
```
После установки на Ribbon-ленте Excel повляется выпадающее меню для доступа к настройкам:

![Title](https://github.com/akolodka/VBA/blob/main/resources/updater_RibbonMenu.jpg)

Пользовательская форма для работы с конфигурацией:

![Title](https://github.com/akolodka/VBA/blob/main/resources/updater_configDefault.jpg)![Title2](https://github.com/akolodka/VBA/blob/main/resources/updater_configBtnSave.jpg)

Элементы управления на форме:
- кнопка открыть каталог проверки обновлений (доступна при указании существующего пути);
- кнопка выбрать каталог проверки обновлений, запускает встроенный инструмент Application.FileDialog(msoFileDialogFolderPicker);
- переключатель опции проверки доступности обновлений (без его активации проверка будет выполняться при запуске формы);
- переключатель опции автоустановки обновлений;
- кнопка установки обновления (появляется при доступности обновления и отключенной опции автоустановки);
- кнопка сохранить / готово;
- выгрузка формы из памяти осуществляется нажатием с клавиатуры Esc по любому элементу управления.

Конфигурация пользователя хранится в файле:
``` 
%appdata%\Помощник ПКР\config\updater.ini
```
Содержимое файла конфигурации:

![Title](https://github.com/akolodka/VBA/blob/main/resources/updater_configContent.jpg)

## Доступ к исходному коду библиотеки из VBA IDE 
Проект библиотеки защищён паролем «1» ввиду обилия компонентов, по умолчанию отображающихся списком в IDE.

## P. s.
Пока писал этот readme, обнаружил изъяны в логике. Вместе с тем, наибольшее применение библиотека нашла в распространении обновлений единичных библиотек Excel, что выполняется корректно и не оказывает влияния на работу других проектов.

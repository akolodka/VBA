# Менеджер обновлений библиотек «Помощник ПКР»
При наличии более чем одного пользователя ПО закономерно возникает вопрос распространения обновлений. 

Установка библиотек *.xlam не требует регистрации в реестре системы и сводится к замене исполняемого файла в каталоге автозапуска MS Office. Но есть нюансы:
- нельзя заменить файл, который в настоящее время используется, а при старте Excel библиотеки запускаются в фоне;
- можно программно закрыть файл надстройки, скопировать обновление и снова подключить файл, но тогда нарушается последовательность отображения меню Ribbon-ленты до следующего перезапуска Excel (надстройки открываются последовательно по алфавиту).

Наиболее гладкий алгоритм установки обновления сводится к трём действиям:
- закрыть файл библиотеки, запущенный в фоне (желательно закрыть Office);
- скопировать файл обновления в служебный локальный каталог автозапуска Office;
- запустить Office.

Открытие служебного каталога вручную через команду «выполнить» утомляет где-то на третий раз.
Применение скрипта VBS, *.py, или bat-файла комфортнее, но всё равно требует вручную закрыть все открытые документы, коих бывает неприлично много в работе. Решение должно быть изящнее, и незаметно работать в среде VBA.

## Область применения
Режимы работы библиотеки:
- стандартный ручной (выполняется проверка наличия обновлений с уведомлением пользователя, установка не производится);
- тихий автоматический (выполняется установка обновлений без уведомления пользователя).

Библиотека распространяется на файлы:
- Excel (*.xlam) — помещаются в каталог:
``` 
%appdata%\Microsoft\Excel\XLSTART\
```
- Word (*.dotm) — помещаются в каталог:
``` 
%appdata%\Microsoft\Word\STARTUP\
```
- Другие файлы, если таковые обнаружены в служебном локальном каталоге «Помощник ПКР» на компьютере пользователя — помещаются в каталог:
``` 
%appdata%\Помощник ПКР\
```

## Принцип работы
Выделено два основных этапа работы библиотеки:
- проверка доступности обновлений;
- установка обновлений.

Проверка доступности обновлений выполнется через событие Workbook_Open() и включается в себя операции:
1. обращение к каталогу обновлений;
2. прохождение по всем файлам, расположенным в каталоге обновлений;
3. определение принадлежности библиотеки (Excel / Word / слежубный файл);
4. поиск совпадения имени файла в каталоге обновлений с локальными служебными каталогами;
5. сравнение даты изменения файла в каталоге обновлений и соответствующем локальном служебном каталоге;
6. переключение флага isUpdateAvailable в положение True, если обнаружен хотя бы один файл новее, чем установленный локально;
7. запись значения флага isUpdateAvailable в файл кеша программы в локальный служебный каталог:
``` 
%appdata%\Помощник ПКР\cache\updater.txt
```
Установка обновлений в автоматическом режиме выполняется через событие Workbook_BeforeClose(). 
Если флаг isUpdateAvailable имеет значение False, происходит завершение процедуры и прерывание установки. 

Операции установки:
- выполнение п.1 — п. 4 проверки доступности обновлений для каждого файла в каталоге обновлений;
- выполнение отключения запущенных библиотек в зависимости от типа файла:
  - для файлов *.xlam выполняется принудительное закрытие;
  - для файлов *.dotm выполняется проверка запущенного процесса WINWORD.EXE, и, если процесс обнаружен, отключение данного файла от Office;
- копирование нового файла в соответствующий каталог.

## Уведомление пользователя о наличии обновления
Уведомление появляется на Ribbon-ленте Excel только при работе в стандартном ручном режиме:

![Title](https://github.com/akolodka/VBA/blob/main/resources/update_available.jpg) ![Title](https://github.com/akolodka/VBA/blob/main/resources/update_unAvailable.jpg)

## Установка и настройка библиотеки
Установка возможна только вручную: поместить в каталог автозагрузки Excel:
``` 
%appdata%\Microsoft\Excel\XLSTART\
```
После установки на Ribbon-ленте Excel повляется выпадающее меню для доступа к настройкам:

![Title](https://github.com/akolodka/VBA/blob/main/resources/updater_RibbonMenu.jpg)

Пользовательская форма:

![Title](https://github.com/akolodka/VBA/blob/main/resources/updater_configMenu.jpg) ![Title](https://github.com/akolodka/VBA/blob/main/resources/updater_configSaveChanges.jpg)

Конфигурация пользователя хранится в файле:
``` 
%appdata%\Помощник ПКР\config\updater.ini
```
Содержимое файла конфигурации:

![Title](https://github.com/akolodka/VBA/blob/main/resources/updater_configContent.jpg)

## Доступ к исходному коду библиотек из VBA IDE 
Проект библиотеки защищён паролем «1» ввиду обилия компонентов, по умолчанию отображающихся списком в IDE.

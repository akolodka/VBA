# Менеджер обновлений компонентов «Помощник ПКР»
При наличии более чем одного пользователя ПО возникает вопрос распространения обновлений компонентов ПО. 

Установка надстроек (библиотек) *.xlam не требует регистрации в реестре системы и сводится к замене исполняемого файла в соответствующем каталоге автозапуска MS Office, но:
- нельзя заменить файл, который в настоящее время открыт в приложении Office, а при старте Excel библиотеки открываются в фоне;
- можно программно закрыть файл библиотеки, скопировать обновление и снова подключить файл, но тогда нарушается последовательность отображения меню Ribbon-ленты до следующего перезапуска приложения Ms Office — библиотеки открываются последовательно по алфавиту.

## Область применения
Настоящая библиотека предусматривает два функциональных режима работы:
- проверка обновлений с уведомлением пользователя, установка не производится;
- автоустановка обновлений в фоновом режиме без уведомления пользователя.

Каталог обновлений располагается на сервере подразделения.

Библиотека распространяется на файлы:
- Excel (*.xlam) — помещаются в каталог:
``` 
%appdata%\Microsoft\Excel\XLSTART\
```
- Word (*.dotm) — помещаются в каталог:
``` 
%appdata%\Microsoft\Word\STARTUP\
```
- Другие файлы, если таковые обнаружены в служебном локальном каталоге «Помощник ПКР» на компьютере пользователя — помещаются в каталог:
``` 
%appdata%\Помощник ПКР\
```

## Принцип работы
### Проверка наличия обновлений
Проверка доступности обновлений включается в себя операции:
1. обращение к каталогу обновлений;
2. получение списка файлов, доступных для обновления;
3. определение статуса доступности обновлений;
4. запись результатов проверки в кеш-файл, расположенный по адресу:
``` 
%appdata%\Помощник ПКР\cache\updater.txt
```

Доступность обновлений проверяется либо через событие Workbook_Open() настоящей библиотеки, либо при запуске пользовательского меню настроек.
Установлено ограничение на проверку обновлений через Workbook_Open() не более раз в сутки, запись о дате проверки помещается в кеш-файл.


Пример содержимого кеш-файла:

![Title](https://github.com/akolodka/VBA/blob/main/resources/updater_CacheContent.jpg)

Статус доступности обновления определяется на основании:
- наличия установленного локально файла библиотеки (поиск совпадения по имени);
- сравнения даты изменения установленного локально файла библиотеки с датой изменения файла обновления.

### Установка обновлений
Операции установки в фоновом режиме:
- получение из кеш-файла списка библиотек, для которых доступно обновление;
- выполнение отключения открытых в фоне библиотек в зависимости от типа файла:
  - для файлов *.xlam выполняется принудительное закрытие;
  - для файлов *.dotm выполняется проверка запущенного процесса WINWORD.EXE, и, если процесс обнаружен, отключение данного файла от Office;
- копирование нового файла в соответствующий каталог.

Установка обновлений в фоновом режиме выполняется через событие Workbook_BeforeClose(). 

Операции установки в обычном режиме включают все операции установки фонового режима плюс операции:
- выполнение отключения всех открытых в фоне библиотек для конкретного приложения Ms Office (закрыть все библиотеки helper_*** для Excel и (или) Word);
- последовательный запуск всех библиотек по алфавиту для сохранения последовательности Ribbon-menu.

## Уведомление пользователя о наличии обновления
Уведомление появляется на Ribbon-ленте Excel только при отключении автоустановки обновлений:

![Title](https://github.com/akolodka/VBA/blob/main/resources/update_available.jpg) ![Title](https://github.com/akolodka/VBA/blob/main/resources/update_unAvailable.jpg)

## Установка и настройка библиотеки
Для установки библиотеки поместить файл helper_updater.xlam в каталог автозагрузки Excel:
``` 
%appdata%\Microsoft\Excel\XLSTART\
```
После установки на Ribbon-ленте Excel повляется выпадающее меню для доступа к настройкам:

![Title](https://github.com/akolodka/VBA/blob/main/resources/updater_RibbonMenu.jpg)

Пользовательская форма для работы с конфигурацией:

![Title](https://github.com/akolodka/VBA/blob/main/resources/updater_configDefault.jpg)![Title2](https://github.com/akolodka/VBA/blob/main/resources/updater_configBtnSave.jpg)

Элементы управления на форме:
- кнопка открыть каталог проверки обновлений (доступна при указании существующего пути);
- кнопка выбрать каталог проверки обновлений, запускает встроенный инструмент Application.FileDialog(msoFileDialogFolderPicker);
- переключатель опции проверки доступности обновлений (без его активации проверка будет выполняться при запуске формы);
- переключатель опции автоустановки обновлений;
- кнопка установки обновления (появляется при доступности обновления и отключенной опции автоустановки);
- кнопка сохранить / готово;
- выгрузка формы из памяти осуществляется нажатием с клавиатуры Esc по любому элементу управления.

Конфигурация пользователя хранится в файле:
``` 
%appdata%\Помощник ПКР\config\updater.ini
```
Содержимое файла конфигурации:

![Title](https://github.com/akolodka/VBA/blob/main/resources/updater_configContent.jpg)

## Доступ к исходному коду библиотеки из VBA IDE 
Проект библиотеки защищён паролем «1» ввиду обилия компонентов, по умолчанию отображающихся списком в IDE.
